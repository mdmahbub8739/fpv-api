<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MultiMovies Player & Extractor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            background-color: #0f172a; 
            color: #e2e8f0; 
            font-family: 'Segoe UI', sans-serif;
        }
        .spinner {
            width: 30px; height: 30px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Video Aspect Ratio Container */
        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            height: 0;
            overflow: hidden;
            background: #000;
            border-radius: 8px;
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="bg-slate-800/90 backdrop-blur-md border-b border-slate-700 sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-lg font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-emerald-400">
                MultiMovies Player
            </h1>
            <span id="status-badge" class="text-xs bg-slate-700 px-2 py-1 rounded text-slate-300">Idle</span>
        </div>
        <div class="bg-slate-900 px-4 py-2 border-b border-slate-800">
            <input type="text" id="searchInput" placeholder="Search movies/series..." 
                class="w-full bg-slate-800 text-white rounded px-4 py-2 focus:outline-none focus:ring-1 focus:ring-emerald-500 border border-slate-700 text-sm">
        </div>
    </header>

    <main class="container mx-auto px-4 py-4 flex-grow">
        <div id="grid-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3"></div>

        <div id="loading-sentinel" class="py-8 text-center w-full">
            <div class="spinner" id="loading-spinner"></div>
            <p class="text-slate-500 text-xs mt-2" id="loading-text">Loading feed...</p>
        </div>
    </main>

    <div id="modal" class="fixed inset-0 bg-black/95 z-[60] hidden flex items-center justify-center p-2 md:p-4 backdrop-blur-sm">
        <div class="bg-slate-900 w-full max-w-5xl max-h-[95vh] rounded-xl border border-slate-700 shadow-2xl overflow-hidden flex flex-col">
            
            <div class="p-3 border-b border-slate-800 flex justify-between items-center bg-slate-800/50">
                <h2 id="modal-title" class="text-md font-bold text-white truncate pr-4">Title</h2>
                <button onclick="app.closeModal()" class="text-slate-400 hover:text-red-400 p-1">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <div class="overflow-y-auto flex-1 p-4 scrollbar-hide">
                
                <div id="player-wrapper" class="hidden mb-6">
                    <div class="video-container">
                        <iframe id="main-player" allowfullscreen="true" scrolling="no"></iframe>
                    </div>
                    <div class="mt-2 flex justify-between items-center bg-black/40 p-2 rounded">
                        <span class="text-[10px] text-slate-400">Streaming Mode: Active</span>
                        <button onclick="app.copyLink()" class="text-xs text-emerald-400 hover:underline">Copy Direct Link</button>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row gap-5">
                    <img id="modal-poster" src="" class="w-32 h-48 object-cover rounded shadow-lg bg-slate-800 shrink-0 mx-auto md:mx-0">
                    
                    <div class="flex-1 space-y-3">
                        <div class="flex gap-2 text-xs">
                            <span id="modal-year" class="px-2 py-1 bg-slate-800 rounded text-slate-300">Year</span>
                            <span id="modal-rating" class="px-2 py-1 bg-yellow-900/30 text-yellow-400 border border-yellow-800 rounded">Rating</span>
                        </div>
                        <p id="modal-plot" class="text-xs text-slate-400 leading-relaxed max-h-24 overflow-y-auto"></p>
                        
                        <div class="bg-black/80 p-2 rounded border border-slate-800 font-mono text-[10px] h-20 overflow-y-auto text-slate-400" id="extraction-log">
                            <span class="text-blue-500">> System Ready.</span>
                        </div>
                        <input type="hidden" id="result-link">
                    </div>
                </div>

                <div class="mt-5 pt-4 border-t border-slate-800">
                    <h3 class="text-xs font-bold text-slate-500 uppercase mb-2">Select Server to Play</h3>
                    <div id="source-list" class="flex flex-wrap gap-2"></div>
                </div>
                
                <div id="episode-section" class="mt-4 hidden">
                    <h3 class="text-xs font-bold text-slate-500 uppercase mb-2">Episodes</h3>
                    <div id="episode-list" class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 gap-2"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            corsProxy: "https://corsproxy.io/?", 
            defaultDomain: "https://multimovies.cheap",
            domainsUrl: "https://raw.githubusercontent.com/phisher98/TVVVV/refs/heads/main/domains.json"
        };

        const state = {
            baseUrl: CONFIG.defaultDomain,
            page: 1,
            fetching: false,
            hasMore: true,
            searchMode: false,
            searchQuery: ""
        };

        const app = {
            init: async () => {
                try {
                    const res = await fetch(CONFIG.corsProxy + encodeURIComponent(CONFIG.domainsUrl));
                    const data = await res.json();
                    if(data?.MultiMovies) state.baseUrl = data.MultiMovies;
                } catch(e) {}

                const observer = new IntersectionObserver((entries) => {
                    if (entries[0].isIntersecting && !state.fetching && state.hasMore) app.fetchFeed();
                }, { rootMargin: "200px" });
                observer.observe(document.getElementById('loading-sentinel'));

                document.getElementById('searchInput').addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') app.doSearch(e.target.value);
                });
            },

            fetchFeed: async () => {
                state.fetching = true;
                document.getElementById('status-badge').innerText = `Page ${state.page}`;
                
                let url = state.searchMode 
                    ? `${state.baseUrl}/page/${state.page}/?s=${encodeURIComponent(state.searchQuery)}`
                    : (state.page === 1 ? `${state.baseUrl}/trending/` : `${state.baseUrl}/trending/page/${state.page}/`);

                try {
                    const doc = await app.getHtml(url);
                    let items = doc.querySelectorAll("#archive-content > article, div.items > article, div.result-item");
                    
                    if (items.length > 0) {
                        app.renderGrid(items);
                        state.page++;
                    } else {
                        state.hasMore = false;
                        document.getElementById('loading-spinner').style.display = 'none';
                        document.getElementById('loading-text').innerText = "End of feed.";
                    }
                } catch (e) {
                    console.error(e);
                } finally {
                    state.fetching = false;
                }
            },

            renderGrid: (nodes) => {
                const grid = document.getElementById('grid-container');
                nodes.forEach(el => {
                    const titleEl = el.querySelector(".data > h3 > a, .title > a");
                    const title = titleEl?.textContent.trim();
                    const href = titleEl?.getAttribute("href");
                    const img = el.querySelector("img")?.getAttribute("data-src") || el.querySelector("img")?.getAttribute("src");
                    const quality = el.querySelector(".mepo > span")?.textContent || "HD";

                    if (title && href) {
                        const div = document.createElement('div');
                        div.className = "bg-slate-800 rounded overflow-hidden cursor-pointer hover:ring-1 hover:ring-emerald-500 transition-all fade-in group";
                        div.innerHTML = `
                            <div class="relative aspect-[2/3]">
                                <img src="${img || ''}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity" loading="lazy">
                                <span class="absolute top-1 right-1 bg-black/60 text-white text-[10px] px-1 rounded border border-white/20">${quality}</span>
                            </div>
                            <div class="p-2">
                                <h3 class="text-xs text-slate-300 truncate font-medium group-hover:text-emerald-400">${title}</h3>
                            </div>
                        `;
                        div.onclick = () => app.openDetails(href);
                        grid.appendChild(div);
                    }
                });
            },

            openDetails: async (url) => {
                const modal = document.getElementById('modal');
                modal.classList.remove('hidden');
                document.getElementById('player-wrapper').classList.add('hidden');
                document.getElementById('main-player').src = "";
                app.log("Loading metadata...");

                const doc = await app.getHtml(url);
                if (!doc) return;

                const title = doc.querySelector("div.sheader > div.data > h1")?.textContent.trim();
                const poster = doc.querySelector("div.g-item a")?.getAttribute("href");
                const plot = doc.querySelector("#info div.wp-content p")?.textContent.trim();

                document.getElementById('modal-title').innerText = title || "Details";
                document.getElementById('modal-poster').src = poster || "";
                document.getElementById('modal-plot').innerText = plot || "No description available.";

                const seasons = doc.querySelectorAll("#seasons ul.episodios");
                if (seasons.length > 0) {
                    app.renderEpisodes(seasons);
                } else {
                    document.getElementById('episode-section').classList.add('hidden');
                    app.loadSources(url, doc);
                }
            },

            renderEpisodes: (seasons) => {
                const section = document.getElementById('episode-section');
                const list = document.getElementById('episode-list');
                section.classList.remove('hidden');
                list.innerHTML = '';
                document.getElementById('source-list').innerHTML = '<span class="text-xs text-slate-500">Select an episode first.</span>';

                seasons.forEach((ul, sIdx) => {
                    ul.querySelectorAll("li").forEach((li, eIdx) => {
                        const link = li.querySelector("a")?.getAttribute("href");
                        if (link) {
                            const btn = document.createElement('button');
                            btn.className = "text-[10px] bg-slate-800 hover:bg-emerald-900 p-2 rounded text-center border border-slate-700 truncate transition-colors";
                            btn.innerText = `S${sIdx+1}:E${eIdx+1}`;
                            btn.onclick = () => app.loadSources(link);
                            list.appendChild(btn);
                        }
                    });
                });
            },

            loadSources: async (url, preDoc = null) => {
                const list = document.getElementById('source-list');
                list.innerHTML = '<span class="text-xs text-slate-500 animate-pulse">Scanning servers...</span>';
                
                let doc = preDoc || await app.getHtml(url);
                const opts = doc.querySelectorAll("ul#playeroptionsul li");
                list.innerHTML = '';

                if(opts.length === 0) {
                    list.innerHTML = '<span class="text-xs text-red-400">No sources found.</span>';
                    return;
                }

                opts.forEach(opt => {
                    const id = opt.getAttribute("data-post");
                    const name = opt.getAttribute("data-nume");
                    const type = opt.getAttribute("data-type");

                    if (id) {
                        const btn = document.createElement('button');
                        btn.className = "bg-slate-800 hover:bg-blue-600 text-slate-300 hover:text-white px-3 py-1 rounded text-xs border border-slate-700 transition-all";
                        btn.innerText = `Server: ${name}`;
                        btn.onclick = () => app.playVideo(id, name, type);
                        list.appendChild(btn);
                    }
                });
                app.log(`Found ${opts.length} servers.`);
            },

            playVideo: async (id, name, type) => {
                app.log(`Fetching stream from ${name}...`);
                const formData = new URLSearchParams();
                formData.append('action', 'doo_player_ajax');
                formData.append('post', id);
                formData.append('nume', name);
                formData.append('type', type);

                try {
                    const res = await fetch(CONFIG.corsProxy + encodeURIComponent(`${state.baseUrl}/wp-admin/admin-ajax.php`), {
                        method: 'POST',
                        headers: {'Content-Type':'application/x-www-form-urlencoded'},
                        body: formData
                    });
                    
                    const json = await res.json();
                    
                    if (json.embed_url) {
                        let link = json.embed_url;
                        const match = link.match(/src="([^"]+)"/);
                        if (match) link = match[1];
                        link = link.replace(/\\/g, '');

                        // Update Player
                        const playerWrapper = document.getElementById('player-wrapper');
                        const iframe = document.getElementById('main-player');
                        const linkStorage = document.getElementById('result-link');
                        
                        linkStorage.value = link;
                        iframe.src = link;
                        playerWrapper.classList.remove('hidden');
                        playerWrapper.scrollIntoView({ behavior: 'smooth' });
                        
                        app.log(`Playing: ${name}`, 'success');
                    } else {
                        app.log("Failed to load stream.", 'error');
                    }
                } catch(e) {
                    app.log("CORS/Network error.", 'error');
                }
            },

            copyLink: () => {
                const link = document.getElementById("result-link").value;
                if(!link) return;
                navigator.clipboard.writeText(link);
                app.log("Link copied!", 'success');
            },

            getHtml: async (url) => {
                const res = await fetch(CONFIG.corsProxy + encodeURIComponent(url));
                if (!res.ok) return null;
                const txt = await res.text();
                return new DOMParser().parseFromString(txt, 'text/html');
            },

            doSearch: (q) => {
                if(!q) return;
                state.searchMode = true;
                state.searchQuery = q;
                state.page = 1;
                state.hasMore = true;
                document.getElementById('grid-container').innerHTML = '';
                app.fetchFeed();
            },

            closeModal: () => {
                document.getElementById('modal').classList.add('hidden');
                document.getElementById('main-player').src = ""; // Stop video on close
            },

            log: (msg, type) => {
                const div = document.getElementById('extraction-log');
                const p = document.createElement('div');
                p.className = type === 'error' ? 'text-red-400' : type === 'success' ? 'text-emerald-400' : 'text-slate-400';
                p.innerText = `> ${msg}`;
                div.prepend(p);
            }
        };

        app.init();
    </script>
</body>
</html>
